{% extends "base.html" %}

{% block title %}디지털성범죄 통계 | 디지털 성범죄 알리미{% endblock %}

{% block content %}
<h1 class="mb-4" style="color: var(--accent); font-weight: 700;">디지털성범죄 통계</h1>

<!-- 연령대별 세부 피해 유형 (스택 바 차트) -->
<div class="card">
  <section class="my-4">
    <h2 class="mb-3" style="color: var(--accent);">연령대별 세부 피해 유형</h2>
    <canvas id="ageTypeChart" height="120"></canvas>
    <script>
      // 테마에 맞는 차트 색상 가져오기
      function getChartColors() {
        const isLightMode = document.documentElement.classList.contains('light-mode');
        return {
          textColor: isLightMode ? '#2c3e50' : '#f5f6fa',
          subTextColor: isLightMode ? '#5a6c7d' : '#b0b3c6',
          gridColor: isLightMode ? 'rgba(0,0,0,0.1)' : 'rgba(255,255,255,0.1)'
        };
      }

      const ageTypeCtx = document.getElementById('ageTypeChart').getContext('2d');
      const colors1 = getChartColors();
      const ageTypeChart = new Chart(ageTypeCtx, {
        type: 'bar',
        data: {
          labels: {{ age_labels | tojson }},
          datasets: [
            {% for type in age_types %}
            {
              label: '{{ type }}',
              data: {{ age_type_values[loop.index0] | tojson }},
              backgroundColor: [
                'rgba(255, 99, 132, 0.8)',   // 빨강
                'rgba(54, 162, 235, 0.8)',   // 파랑
                'rgba(255, 206, 86, 0.8)',   // 노랑
                'rgba(75, 192, 192, 0.8)',   // 청록
                'rgba(153, 102, 255, 0.8)',  // 보라
                'rgba(255, 159, 64, 0.8)',   // 주황
                'rgba(199, 199, 199, 0.8)',  // 회색
                'rgba(83, 102, 255, 0.8)'    // 남색
              ][{{ loop.index0 }}] || 'rgba({{ 60+loop.index0*40 }}, {{ 120+loop.index0*30 }}, {{ 200-loop.index0*20 }}, 0.8)',
              borderColor: [
                'rgba(255, 99, 132, 1)',
                'rgba(54, 162, 235, 1)',
                'rgba(255, 206, 86, 1)',
                'rgba(75, 192, 192, 1)',
                'rgba(153, 102, 255, 1)',
                'rgba(255, 159, 64, 1)',
                'rgba(199, 199, 199, 1)',
                'rgba(83, 102, 255, 1)'
              ][{{ loop.index0 }}] || 'rgba({{ 60+loop.index0*40 }}, {{ 120+loop.index0*30 }}, {{ 200-loop.index0*20 }}, 1)',
              borderWidth: 2
            }{% if not loop.last %},{% endif %}
            {% endfor %}
          ]
        },
        options: {
          plugins: {
            legend: { labels: { color: colors1.textColor } }
          },
          responsive: true,
          scales: {
            x: { 
              stacked: true, 
              title: { display: true, text: '연령대', color: colors1.subTextColor }, 
              ticks: { color: colors1.subTextColor },
              grid: { color: colors1.gridColor }
            },
            y: { 
              stacked: true, 
              beginAtZero: true, 
              title: { display: true, text: '건수', color: colors1.subTextColor }, 
              ticks: { color: colors1.subTextColor },
              grid: { color: colors1.gridColor }
            }
          }
        }
      });

      // 테마 변경 시 차트 색상 업데이트
      document.addEventListener('themeChanged', function() {
        const newColors = getChartColors();
        ageTypeChart.options.plugins.legend.labels.color = newColors.textColor;
        ageTypeChart.options.scales.y.title.color = newColors.subTextColor;
        ageTypeChart.options.scales.y.ticks.color = newColors.subTextColor;
        ageTypeChart.options.scales.y.grid.color = newColors.gridColor;
        ageTypeChart.options.scales.x.title.color = newColors.subTextColor;
        ageTypeChart.options.scales.x.ticks.color = newColors.subTextColor;
        ageTypeChart.options.scales.x.grid.color = newColors.gridColor;
        ageTypeChart.update();
      });
    </script>
    <div style="color: var(--text-sub); font-size: 0.98rem; margin-top: 0.5rem;">
      *출처: 한국여성인권진흥원 디지털성범죄피해자지원센터 연령대별 세부 피해 유형 현황
    </div>
  </section>
</div>

<!-- 연도별 지원현황 (라인 차트) -->
<div class="card">
  <section class="my-4">
    <h2 class="mb-3" style="color: var(--accent);">연도별 지원현황</h2>
    <canvas id="supportChart" height="120"></canvas>
    <script>
      const supportCtx = document.getElementById('supportChart').getContext('2d');
      const colors2 = getChartColors();
      const supportChart = new Chart(supportCtx, {
        type: 'line',
        data: {
          labels: {{ year_labels | tojson }},
          datasets: [
            {% for type in support_types %}
            {
              label: '{{ type }}',
              data: {{ support_type_values[loop.index0] | tojson }},
              borderColor: 'rgba({{ 59+loop.index0*30 }}, 76, 202, 1)',
              backgroundColor: 'rgba({{ 60+loop.index0*30 }}, {{ 99+loop.index0*20 }}, 255, 0.2)',
              borderWidth: 2,
              tension: 0.3,
              fill: false
            }{% if not loop.last %},{% endif %}
            {% endfor %}
          ]
        },
        options: {
          plugins: {
            legend: { labels: { color: colors2.textColor } }
          },
          responsive: true,
          scales: {
            x: { 
              title: { display: true, text: '연도', color: colors2.subTextColor }, 
              ticks: { color: colors2.subTextColor },
              grid: { color: colors2.gridColor }
            },
            y: { 
              beginAtZero: true, 
              title: { display: true, text: '건수', color: colors2.subTextColor }, 
              ticks: { color: colors2.subTextColor },
              grid: { color: colors2.gridColor }
            }
          }
        }
      });

      // 테마 변경 시 차트 색상 업데이트
      document.addEventListener('themeChanged', function() {
        const newColors = getChartColors();
        supportChart.options.plugins.legend.labels.color = newColors.textColor;
        supportChart.options.scales.y.title.color = newColors.subTextColor;
        supportChart.options.scales.y.ticks.color = newColors.subTextColor;
        supportChart.options.scales.y.grid.color = newColors.gridColor;
        supportChart.options.scales.x.title.color = newColors.subTextColor;
        supportChart.options.scales.x.ticks.color = newColors.subTextColor;
        supportChart.options.scales.x.grid.color = newColors.gridColor;
        supportChart.update();
      });
    </script>
    <div style="color: var(--text-sub); font-size: 0.98rem; margin-top: 0.5rem;">
      *출처: 한국여성인권진흥원 디지털성범죄피해자지원센터 지원현황
    </div>
  </section>
</div>
{% endblock %} 